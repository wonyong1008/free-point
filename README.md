# Musinsa Point System

무신사페이먼츠 백엔드 엔지니어 과제를 진행하며 만든 무료 포인트 관리 API입니다.  
포인트 적립부터 만료까지 전 과정을 추적할 수 있고, JWT 인증/인가까지 넣어 실서비스에서도 곧바로 써도 되는 구조로 정리했습니다.

## 1. 모듈 & 기술 스택

### 모듈 구성
- **point-core**: 엔티티, 리포지토리, 핵심 서비스, 공통 설정
- **point-api**: REST API, 인증, Swagger UI, `PointApplication`
- **point-batch**: 만료 배치 전용 애플리케이션 (`PointBatchApplication`)

|구분|내용|
|---|---|
|언어/런타임|Java 21, Gradle 8|
|프레임워크|Spring Boot 3.2 (Web, Data JPA, Validation, Security, Actuator)|
|DB|H2 (파일 모드)|
|빌드/검증|JUnit 5, Spring Security Test, QueryDSL|
|문서화|SpringDoc OpenAPI 3 (Swagger UI)|

## 2. 아키텍처 & 주요 컴포넌트

- **Domain Layer**
  - `PointEarning/PointUsage/PointUsageDetail` : 적립·사용 단위를 저장하며 만료·복구 로직을 내포합니다.
  - `PointHistory` : 모든 거래를 ACCUMULATE/USE/USE_CANCEL/EXPIRE 타입으로 기록합니다.
  - `Member` + `RefreshToken` : JWT 인증 주체와 리프레시 토큰 저장소.
- **Service Layer**
  - `PointService` : 수기 포인트 우선, 만료 시 재적립, 부분 취소 등을 모두 캡슐화했습니다.
  - `PointExpirationScheduler` : cron 기반 만료 배치, Micrometer 카운터(`point.expire.count`)와 이력 남김.
  - `AuthService` : 회원가입, 로그인, Refresh 토큰 재발급.
- **Security Layer**
  - `JwtTokenProvider`, `JwtAuthenticationFilter` : Access Token 생성·검증.
  - `SecurityProperties` : 토큰 시크릿/만료 시간을 외부 설정으로 분리.


## 3. 인증 흐름

1. `POST /api/auth/signup` : 이메일/비밀번호로 회원가입.
2. `POST /api/auth/login` : Access/Refresh Token 획득.
3. `POST /api/auth/refresh` : Refresh Token으로 Access Token 재발급.
4. 모든 `/api/points/**` 호출 시 `Authorization: Bearer <ACCESS_TOKEN>` 헤더가 필요합니다.

Swagger UI에서 `Authorize` 버튼을 눌러 `Bearer <accessToken>`을 입력하면 인증된 호출을 바로 테스트할 수 있습니다.

## 4. 비즈니스 규칙

|영역|규칙|
|---|---|
|적립|1회 1~100,000포인트, 개인 최대 보유량은 `PointConfig`로 조정|
|만료|기본 365일, 1일 이상 5년 미만. 만료되면 `EXPIRE` 이력과 함께 잔액 0 처리|
|사용|수기 포인트 우선, 만료 임박 순으로 차감. 주문번호 필수|
|사용 취소|전체/부분 모두 가능. 만료된 포인트를 취소하면 새 적립으로 되살림|
|추적성|`PointUsageDetail`로 1원 단위 매핑, `PointHistory`로 모든 거래 기록|

## 5. API 개요

### 인증 API (`/api/auth`)
|Method|Path|설명|
|---|---|---|
|POST|`/signup`|회원가입|
|POST|`/login`|로그인 및 access/refresh 발급|
|POST|`/refresh`|Refresh Token으로 재발급|

### 포인트 API (`/api/points`)
|Method|Path|설명|
|---|---|---|
|POST|`/accumulate`|포인트 적립|
|POST|`/accumulate/cancel`|적립 취소 (미사용분)|
|POST|`/use`|주문 시 포인트 사용|
|POST|`/use/cancel`|사용 취소 (전부/일부)|
|GET|`/balance/{userId}`|현재 잔액 조회|
|GET|`/history/{userId}`|트랜잭션 이력 조회|

필드/응답 예시는 Swagger (`/swagger-ui.html`)와 `point-core/src/main/java/com/musinsa/point/dto/**`에서 확인할 수 있습니다.

## 6. 실행 방법

### 1) .env (또는 환경 변수) 작성
```
DB_URL=jdbc:h2:file:./data/pointdb;AUTO_SERVER=TRUE
DB_USERNAME=sa
DB_PASSWORD=
JWT_SECRET=please_change_this_secret_key
POINT_EXPIRATION_CRON=0 0 * * * *
POINT_EXPIRATION_BATCH_SIZE=500
```

### 2) 실행 순서
```bash
./gradlew build
# API 서버 (포트 8080)
java -jar point-api/build/libs/point-api-0.0.1-SNAPSHOT.jar &

# 배치 서버 (포트 8081, 만료 작업)
java -jar point-batch/build/libs/point-batch-0.0.1-SNAPSHOT.jar &
```
- API 서버는 8080, 배치 서버는 `point-batch/src/main/resources/application.yml`에서 8081로 고정해 두었습니다. 두 프로세스를 서로 다른 터미널에서 실행하면 로컬에서도 동시에 동작합니다.

### 3) 초기 스키마를 수동으로 만드는 경우
파일 기반 H2에 기존 스키마가 없으면 아래 DDL을 실행해 테이블과 주석을 한 번 만들어 주세요.  
(`spring.jpa.hibernate.ddl-auto=create-drop` 또는 `create`로 바꾸면 애플리케이션이 자동으로 생성하므로 직접 실행할 필요가 없습니다.)
```sql
CREATE TABLE members (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email VARCHAR(100) NOT NULL UNIQUE,
    password VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL,
    created_at TIMESTAMP NOT NULL
);
COMMENT ON TABLE members IS 'JWT 인증 대상 회원';
COMMENT ON COLUMN members.email IS '로그인 이메일 (unique)';
COMMENT ON COLUMN members.password IS 'BCrypt 해시된 비밀번호';
COMMENT ON COLUMN members.role IS 'USER/ADMIN 등 권한';
COMMENT ON COLUMN members.created_at IS '가입 시각';

CREATE TABLE refresh_tokens (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    member_id BIGINT NOT NULL,
    token VARCHAR(255) NOT NULL UNIQUE,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL,
    CONSTRAINT fk_refresh_member
        FOREIGN KEY (member_id) REFERENCES members(id)
);
COMMENT ON TABLE refresh_tokens IS '회원별 Refresh Token 보관';
COMMENT ON COLUMN refresh_tokens.token IS '랜덤 UUID 문자열';

CREATE TABLE point_configs (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    config_key VARCHAR(50) NOT NULL UNIQUE,
    config_value BIGINT NOT NULL
);
COMMENT ON TABLE point_configs IS '포인트 환경 설정 (적립 한도, 보유 한도 등)';

CREATE TABLE point_earnings (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    point_key VARCHAR(50) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    amount BIGINT NOT NULL,
    remaining_amount BIGINT NOT NULL,
    expiration_date TIMESTAMP NOT NULL,
    is_manual BOOLEAN NOT NULL,
    created_at TIMESTAMP NOT NULL
);
COMMENT ON TABLE point_earnings IS '개별 포인트 적립 단위';
COMMENT ON COLUMN point_earnings.is_manual IS '수기 지급 여부';

CREATE TABLE point_usages (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    point_key VARCHAR(50) NOT NULL UNIQUE,
    user_id BIGINT NOT NULL,
    order_number VARCHAR(50) NOT NULL,
    amount BIGINT NOT NULL,
    cancellable_amount BIGINT NOT NULL,
    created_at TIMESTAMP NOT NULL
);
COMMENT ON TABLE point_usages IS '포인트 사용(차감) 내역';
COMMENT ON COLUMN point_usages.cancellable_amount IS '남은 취소 가능 금액';

CREATE TABLE point_usage_details (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    point_usage_id BIGINT NOT NULL,
    point_earning_id BIGINT NOT NULL,
    amount BIGINT NOT NULL,
    CONSTRAINT fk_detail_usage
        FOREIGN KEY (point_usage_id) REFERENCES point_usages(id),
    CONSTRAINT fk_detail_earning
        FOREIGN KEY (point_earning_id) REFERENCES point_earnings(id)
);
COMMENT ON TABLE point_usage_details IS '적립과 사용 매핑 (1원 단위 추적)';

CREATE TABLE point_histories (
    id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id BIGINT NOT NULL,
    type VARCHAR(20) NOT NULL,
    point_key VARCHAR(50) NOT NULL,
    order_number VARCHAR(50),
    amount BIGINT NOT NULL,
    balance BIGINT NOT NULL,
    created_at TIMESTAMP NOT NULL
);
COMMENT ON TABLE point_histories IS 'ACCUMULATE/USE/USE_CANCEL/EXPIRE 이력';
COMMENT ON COLUMN point_histories.balance IS '거래 후 사용자 총 잔액';
```

### 3) 자주 쓰는 URL (API 서버)
- Swagger UI : http://localhost:8080/swagger-ui.html
- H2 콘솔 : http://localhost:8080/h2-console  
  - JDBC URL: `jdbc:h2:file:./data/pointdb;AUTO_SERVER=TRUE`  
  - User: `sa`
- 쿼리 로그는 `p6spy` 스타터 덕분에 콘솔에 한 줄 포맷으로 출력되며, 설정은 `application.yml`의 `decorator.datasource.p6spy` 블록에서 제어합니다.

## 7. 사용 순서 예시

```bash
# 1. 회원가입
curl -X POST http://localhost:8080/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password123"}'

# 2. 로그인 (Access/Refresh 발급)
ACCESS=$(curl -s http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"user@example.com","password":"password123"}' | jq -r '.accessToken')

# 3. 포인트 적립
curl -X POST http://localhost:8080/api/points/accumulate \
  -H "Authorization: Bearer $ACCESS" \
  -H "Content-Type: application/json" \
  -d '{"userId":1,"amount":1000,"isManual":false}'
```

## 8. 테스트

Gradle `test` 태스크로 전체 테스트를 돌릴 수 있습니다.
```bash
./gradlew test
```
- `PointServiceTest` : 적립/사용/취소 로직 검증
- `PointExpirationSchedulerTest` : 만료 배치 검증
- `AuthServiceTest` : 회원가입 → 로그인 → 재발급 흐름 검증

## 9. 참고 문서

- `src/main/resources` : ERD/아키텍처 이미지 첨부 위치
